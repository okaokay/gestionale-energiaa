# Dockerfile per ambiente di sviluppo
FROM node:20

# Installa SQLite3 e altre dipendenze di sistema necessarie
RUN apt-get update && apt-get install -y \
    sqlite3 \
    python3 \
    python3-pip \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Imposta la directory di lavoro
WORKDIR /app

# Copia tutti i file sorgente
COPY . .

# Installa le dipendenze del progetto principale (incluse quelle di sviluppo)
RUN npm install

# Installa le dipendenze del frontend
WORKDIR /app/frontend
RUN npm install

# Torna alla directory principale
WORKDIR /app

# Crea le directory necessarie
RUN mkdir -p uploads/temp uploads/contracts uploads/documenti backend/database

# Build del frontend per produzione
WORKDIR /app/frontend
RUN npm run build

# Torna alla directory principale
WORKDIR /app

# Compila TypeScript del backend
RUN npm run build

# Esegui le migrazioni del database per creare tutte le tabelle necessarie
RUN npm run db:migrate

# Espone solo la porta del backend per produzione
EXPOSE 3001

# Variabili d'ambiente per produzione (ma usando Dockerfile.dev)
ENV NODE_ENV=production
ENV PORT=3001

# Comando di avvio per produzione
CMD ["npm", "start"]