version: "3.8"

name: gestionale-energia

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Temporarily disable automatic HTTP->HTTPS redirection to allow access while LE rate limits are active
      # - --entrypoints.web.http.redirections.entryPoint.to=websecure
      # - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=admin@gmgestionale.cloud
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --accesslog=true
      - --log.level=INFO
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
    networks:
      - proxy

  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: gestionale-energia-app:latest
    container_name: gestionale-energia-app
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: 3001
      FRONTEND_URL: https://gmgestionale.cloud
      BACKEND_URL: https://gmgestionale.cloud/api
      IS_DOCKER: "true"
      DATABASE_PATH: /app/data/gestionale_energia.db
    # Usa il CMD del Dockerfile (scripts/start-with-migrate.js)
    restart: unless-stopped
    expose:
      - "3001"
    volumes:
      - uploads_data:/app/uploads
      - database_data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 20s
      timeout: 5s
      retries: 5
    networks:
      - proxy

  nginx:
    image: nginx:alpine
    container_name: gestionale-energia-nginx
    restart: unless-stopped
    depends_on:
      - app
    # Evita mount di file locali non presenti su Docker Manager
    # Usa heredoc con shell login (-l) per compatibilit√† su alpine
    command: |
      sh -lc 'cat <<"EOF" > /etc/nginx/nginx.conf
      events {
          worker_connections 1024;
      }

      http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;

          log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

          access_log /var/log/nginx/access.log main;
          error_log /var/log/nginx/error.log warn;

          gzip on;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_proxied any;
          gzip_comp_level 6;
          gzip_types
              text/plain
              text/css
              text/xml
              text/javascript
              application/json
              application/javascript
              application/xml+rss
              application/atom+xml
              image/svg+xml;

          limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
          limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

          server {
              listen 80;
              server_name srv1072066.hstgr.cloud gmgestionale.cloud;

              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src 'self' https: data: blob; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://editor.unlayer.com https://*.unlayer.com; connect-src 'self' https://editor.unlayer.com https://api.unlayer.com wss:; frame-src 'self' https://editor.unlayer.com https://*.unlayer.com; img-src 'self' https: data: blob; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:" always;

              location / {
                  proxy_pass http://app:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }

              location /api/ {
                  limit_req zone=api burst=20 nodelay;
                  client_max_body_size 50M;
                  proxy_request_buffering off;
                  proxy_pass http://app:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }

              location /api/auth/login {
                  limit_req zone=login burst=3 nodelay;
                  proxy_pass http://app:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /health {
                  proxy_pass http://app:3001;
                  access_log off;
              }

              location /uploads/ {
                  proxy_pass http://app:3001;
                  client_max_body_size 50M;
                  proxy_request_buffering off;
              }

              error_page 404 /index.html;
              error_page 500 502 503 504 /50x.html;
              location = /50x.html {
                  root /usr/share/nginx/html;
              }
          }
      }
      EOF
      nginx -g "daemon off;"'
    expose:
      - "80"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Router HTTP con redirect automatico a HTTPS
      - "traefik.http.routers.gmgestionale-http.rule=Host(`gmgestionale.cloud`,`www.gmgestionale.cloud`)"
      - "traefik.http.routers.gmgestionale-http.entrypoints=web"
      # Temporarily disable redirect middleware on HTTP router
      # - "traefik.http.routers.gmgestionale-http.middlewares=gmgestionale-redirect"
      # - "traefik.http.middlewares.gmgestionale-redirect.redirectscheme.scheme=https"
      # Router HTTPS con TLS e Let's Encrypt
      - "traefik.http.routers.gmgestionale-https.rule=Host(`gmgestionale.cloud`,`www.gmgestionale.cloud`)"
      - "traefik.http.routers.gmgestionale-https.entrypoints=websecure"
      - "traefik.http.routers.gmgestionale-https.tls=true"
      - "traefik.http.routers.gmgestionale-https.tls.certresolver=le"
      - "traefik.http.services.gmgestionale.loadbalancer.server.port=80"
    networks:
      - proxy

networks:
  proxy:
    driver: bridge

volumes:
  traefik-certs:
  uploads_data:
  database_data:
    driver: local